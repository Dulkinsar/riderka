<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>University Search | Dulat the Great</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-[#FFC700] min-h-screen flex flex-col items-center justify-center p-8">
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold text-[#6B3FA0] mb-4">Find Your Perfect University</h1>
      <p class="text-lg text-[#6B3FA0]">
        Search and explore universities around the globe.
      </p>
    </div>

    <!-- Search Box -->
    <div class="w-full max-w-xl mb-8">
      <div class="bg-white p-6 rounded-2xl shadow-xl">
        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
          <input
            id="searchInput"
            type="text"
            placeholder="Search by name or country"
            class="w-full border-2 border-[#6B3FA0] text-[#6B3FA0] px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6B3FA0]"
          />
          <button
            onclick="performSearch()"
            class="w-full sm:w-auto bg-[#6B3FA0] hover:bg-[#573083] text-white px-6 py-2 rounded-lg flex items-center justify-center"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none"
              viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
            </svg>
            Search
          </button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="w-full max-w-3xl space-y-4"></div>

    <script>
      const apiKey = 'elV9DCUH7kojfZmIamQHtcaTZ6Vpf2n9tXVLmH39'; // Replace with your College Scorecard API key

      async function performSearch() {
        const query = document.getElementById("searchInput").value.trim().toLowerCase();
        if (!query) return;

        const sparqlQuery = `
          SELECT ?universityLabel ?countryLabel ?website WHERE {
            ?university wdt:P31 wd:Q3918.
            OPTIONAL { ?university wdt:P17 ?country. }
            OPTIONAL { ?university wdt:P856 ?website. }
            SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
            FILTER(CONTAINS(LCASE(STR(?universityLabel)), \"${query}\") || CONTAINS(LCASE(STR(?countryLabel)), \"${query}\"))
          }
          LIMIT 10
        `;

        try {
          const res = await fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparqlQuery), {
            headers: { Accept: "application/sparql-results+json" },
          });
          const data = await res.json();
          const results = data.results.bindings;

          const enrichedResults = await Promise.all(results.map(async (item) => {
            const name = item.universityLabel?.value || "";
            const country = item.countryLabel?.value || "";
            const website = item.website?.value || null;

            let extraInfo = null;
            if (country.toLowerCase() === "united states") {
              const collegeApiUrl = `https://api.data.gov/ed/collegescorecard/v1/schools.json?api_key=${apiKey}&school.name=${encodeURIComponent(name)}&fields=school.name,school.city,school.state,school.school_url,latest.cost.tuition.in_state,latest.cost.tuition.out_of_state,latest.admissions.admission_rate.overall`;
              try {
                const usRes = await fetch(collegeApiUrl);
                const usData = await usRes.json();
                if (usData.results.length > 0) {
                  extraInfo = usData.results[0];
                }
              } catch (error) {
                console.error("College Scorecard API error:", error);
              }
            }

            return { name, country, website, extraInfo };
          }));

          displayResults(enrichedResults);

        } catch (err) {
          console.error("Wikidata fetch error:", err);
          document.getElementById("results").innerHTML = '<p class="text-[#6B3FA0] text-center">Something went wrong. Try again later.</p>';
        }
      }

      function displayResults(results) {
        const container = document.getElementById("results");
        container.innerHTML = "";

        if (results.length === 0) {
          container.innerHTML = "<p class='text-[#6B3FA0] text-center'>No universities found.</p>";
          return;
        }

        results.forEach((item) => {
          const { name, country, website, extraInfo } = item;

          const card = document.createElement("div");
          card.className = "bg-white p-6 rounded-xl shadow-md";
          card.innerHTML = `
            <h2 class="text-2xl font-semibold text-[#6B3FA0] mb-1">${name}</h2>
            <p class="text-[#6B3FA0] mb-1">${country}</p>
            ${website ? `<a href="${website}" target="_blank" class="text-blue-600 underline">Visit Website</a>` : ""}
            ${extraInfo ? `
              <p class="text-[#6B3FA0] mt-2 text-sm">City: ${extraInfo["school.city"]}, ${extraInfo["school.state"]}</p>
              <p class="text-[#6B3FA0] text-sm">In-State Tuition: $${extraInfo["latest.cost.tuition.in_state"] || 'N/A'}</p>
              <p class="text-[#6B3FA0] text-sm">Out-of-State Tuition: $${extraInfo["latest.cost.tuition.out_of_state"] || 'N/A'}</p>
              <p class="text-[#6B3FA0] text-sm">Admission Rate: ${(extraInfo["latest.admissions.admission_rate.overall"] * 100).toFixed(2)}%</p>
            ` : ""}
          `;

          container.appendChild(card);
        });
      }
    </script>
  </body>
</html>
